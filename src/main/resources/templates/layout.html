<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta http-equiv="X-UA-Compatible" content="IE=11">
  <title>WIO SERVICE</title>
  <link rel="stylesheet" href="https://adminlte.io/themes/v3/plugins/fontawesome-free/css/all.min.css">
  <link rel="stylesheet" href="https://adminlte.io/themes/v3/dist/css/adminlte.min.css">
  <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
  <script src="https://adminlte.io/themes/v3/dist/js/adminlte.min.js"></script>

  <style>
    body {
      font-family: 'NanumSquare', sans-serif;
    }
    .content-wrapper {
      min-height: calc(100vh - 57px - 60px);
      padding-bottom: 60px;
    }
    footer {
      position: fixed;
      bottom: 0;
      width: 100%;
      height: 60px;
      background-color: #f8f9fa;
      text-align: center;
      line-height: 60px;
    }
    .navbar-toggler {
      border: none;
      background: transparent;
      color: #000;
      font-size: 24px;
      margin-left: 10px;
    }
    .main-sidebar {
      background-color: #2d3e50;
    }
    .nav-sidebar .nav-link {
      color: #9aa0ac;
      font-size: 14px;
      font-weight: normal;
    }
    .nav-sidebar .nav-link.active {
      background-color: #27343b;
      color: #fff;
      border-radius: 0.25rem;
      font-weight: bold;
    }
    .nav-sidebar .nav-link:hover {
      background-color: #27343b;
      color: #fff;
      border-radius: 0.25rem;
    }
    .top-menu .nav-icon {
      color: #9aa0ac;
      font-size: 18px;
    }
    .nav-sidebar .nav-link p {
      margin-left: 5px;
    }
    .nav-treeview > .nav-item > .nav-link {
      margin-left: 15px; /* 중메뉴 들여쓰기 */
      font-size: 13px; /* 중메뉴 폰트 사이즈 */
    }
    .nav-treeview .nav-treeview > .nav-item > .nav-link {
      margin-left: 20px; /* 소메뉴 들여쓰기 */
      font-size: 12px; /* 소메뉴 폰트 사이즈 */
    }
    /* 숨김 스타일 추가 */
    .hidden {
      position: absolute;
      left: -9999px;
      top: -9999px;
    }
    .chart {
      height: 200px;
    }
    .modal-backdrop {
      position: fixed;
      top: 0;
      left: 0;
      z-index: 1040;
      width: 100vw;
      height: 100vh;
      background-color: rgba(0, 0, 0, 0.5);
    }

    .modal-open .modal {
      overflow-x: hidden;
      overflow-y: auto;
    }

    .modal-header {
      background-color: #1681ec;
      color: #fff;
    }

    .modal-footer {
      display: flex;
      justify-content: flex-end;
      padding: 0.75rem;
      background-color: #f8f9fa;
    }

    .modal-footer .btn {
      margin-left: 0.5rem;
    }
    .blink {
      animation: blinker 1s linear infinite;
    }

    @keyframes blinker {
      50% {
        opacity: 0;
      }
    }
    @media (max-width: 768px) {
      .col-md-3, .col-md-4 {
        flex: 0 0 100%;
        max-width: 100%;
        margin-bottom: 15px;
      }
    }
    .info-box {
      border-radius: 0.25rem;
      box-shadow: 0 0 1px rgba(0,0,0,.125), 0 1px 3px rgba(0,0,0,.2);
      display: block;
      margin-bottom: 20px;
      min-height: 90px;
      padding: 15px;
      position: relative;
    }
    .info-box-content {
      padding: 5px 10px;
      flex: 1;
    }
    .info-box-text {
      display: block;
      font-size: 14px;
      margin-bottom: 0;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .info-box-number {
      display: block;
      font-size: 18px;
      font-weight: bold;
    }
    .card {
      box-shadow: 0 0 1px rgba(0,0,0,.125), 0 1px 3px rgba(0,0,0,.2);
      margin-bottom: 1rem;
    }
    .table-responsive {
      max-height: 400px;
      overflow-y: auto;
    }
  </style>
</head>
<body class="hold-transition sidebar-mini layout-fixed">
<div class="wrapper">

  <div id="header-container" th:replace="~{header :: header}"></div>

  <aside class="main-sidebar sidebar-dark-primary elevation-4" id="sidebar">
    <div class="sidebar">
      <nav class="mt-2">
        <ul id="dynamic-menu" class="nav nav-pills nav-sidebar flex-column" data-widget="treeview" role="menu" data-accordion="false">
          <!-- Dynamic menu will be appended here -->
        </ul>
      </nav>
    </div>
  </aside>

  <div class="content-wrapper">
    <div id="content-placeholder" class="content" th:replace="~{fragments/dashboard :: content}">
      <div id="tab-container">
        <ul id="tabList"></ul>
        <div id="tabContent"></div>
      </div>
      <div id="myTabContent" class="tab-content"></div>
    </div>
  </div>

  <footer class="main-footer">
    <strong>&copy; 2024 WIO. All rights reserved.</strong>
  </footer>
</div>

<!-- Include Modal HTML -->
<div th:replace="modal/callInModal :: modal"></div>
<script th:inline="javascript">
  /*<![CDATA[*/
  var menuDataString = /*[[${menuListJson}]]*/ '[]';
  /*]]>*/
</script>
<script>
  $(document).ready(function() {
    // 콘텐츠가 동적으로 로드된 이후에 메뉴와 탭을 초기화하는 함수
    function initializeMenuAndTabsAfterContentLoad() {
      console.log("initializeMenuAndTabsAfterContentLoad 호출됨");

      var tabList = document.getElementById('tabList');
      var contentArea = document.getElementById('tabContent');

      // 요소가 존재하지 않으면 경고를 출력하고 함수를 종료합니다.
      if (!tabList || !contentArea) {
        console.error('tabList or tabContent element not found');
        return;
      }

      // 전화받기 버튼 클릭 시 탭 추가하는 부분
      $(document).on('click', '.btn-answer', function() {
        console.log("전화받기---");
        var pNo = $('#modalPNo').text();
        var cNo = $('#modalCNo').text();
        var projectName = $('#modalProjectName').text();
        var personName = $('#modalPersonName').text();

        // 고유 탭 ID 생성
        var tabId = 'tab-' + cNo.replace(/[^a-zA-Z0-9]/g, '');

        if (tabMap[tabId]) {
          // 기존 탭 활성화
          var existingTab = document.querySelector('.tab-item[data-tab-id="' + tabId + '"]');
          if (existingTab) {
            existingTab.click();
          }
        } else {
          tabCounter++;
          tabMap[tabId] = true;

          // 새 탭 추가
          var tabItem = document.createElement('div');
          tabItem.className = 'tab-item';
          tabItem.setAttribute('data-tab-id', tabId);
          tabItem.innerHTML = personName + ' (' + cNo + ')';
          if (tabList) {
            tabList.appendChild(tabItem);
          }

          var contentDiv = document.createElement('div');
          contentDiv.id = tabId;
          contentDiv.className = 'tab-content';
          contentDiv.style.display = 'none';
          contentDiv.innerHTML = '<h4>' + personName + ' - ' + cNo + '</h4>' +
                  '<p><strong>내선 번호:</strong> ' + pNo + '</p>' +
                  '<p><strong>프로젝트 이름:</strong> ' + projectName + '</p>' +
                  '<p>여기에 상세 내용을 입력하세요.</p>';
          if (contentArea) {
            contentArea.appendChild(contentDiv);
          }

          tabItem.addEventListener('click', function() {
            // 모든 탭 비활성화 및 콘텐츠 숨기기
            var tabs = document.querySelectorAll('.tab-item');
            tabs.forEach(function(tab) {
              tab.classList.remove('active');
            });
            var contents = document.querySelectorAll('.tab-content');
            contents.forEach(function(content) {
              content.style.display = 'none';
            });

            // 현재 클릭한 탭 활성화 및 관련 콘텐츠 표시
            tabItem.classList.add('active');
            document.getElementById(tabId).style.display = 'block';
          });

          tabItem.click();
        }

        // 모달 숨기기 (IE 호환성을 위해 .modal('hide') 대신 다른 방식 사용)
        var callModal = document.getElementById('callModal');
        if (callModal) {
          callModal.style.display = 'none';
          document.body.classList.remove('modal-open');
          var backdrop = document.querySelector('.modal-backdrop');
          if (backdrop) {
            backdrop.parentNode.removeChild(backdrop);
          }
        }
      });
    }

    // 콘텐츠가 동적으로 로드된 후 호출
    $('#content-placeholder').load('/dashboard', function() {
      console.log('Dashboard 콘텐츠 로드됨');
      initializeMenuAndTabsAfterContentLoad(); // 콘텐츠가 로드된 이후에 메뉴와 탭 초기화
    });

    // 메뉴 초기화 함수
    function initializeMenu(menuData) {
      var menuHtml = '';
      if (Array.isArray(menuData)) {
        var topMenus = menuData.filter(function(menu) {
          return menu.MENU_REF === 0;
        });

        topMenus.forEach(function(topMenu) {
          menuHtml += '<li class="nav-item has-treeview">' +
                  '<a href="#" class="nav-link top-menu">' +
                  '<i class="nav-icon ' + getIconClass(topMenu.MENU_NM) + '"></i>' +
                  '<p>' + topMenu.MENU_NM + '<i class="right fas fa-angle-left"></i></p>' +
                  '</a>' +
                  '<ul class="nav nav-treeview">';

          var midMenus = menuData.filter(function(menu) {
            return menu.MENU_REF === topMenu.MENU_CD;
          });

          midMenus.forEach(function(midMenu) {
            menuHtml += '<li class="nav-item has-treeview">' +
                    '<a href="#" class="nav-link mid-menu">' +
                    '<p>' + midMenu.MENU_NM + '<i class="right fas fa-angle-left"></i></p>' +
                    '</a>' +
                    '<ul class="nav nav-treeview">';

            var lowMenus = menuData.filter(function(menu) {
              return menu.MENU_REF === midMenu.MENU_CD;
            });

            lowMenus.forEach(function(lowMenu) {
              menuHtml += '<li class="nav-item">' +
                      '<a href="#" class="nav-link low-menu" data-url="' + lowMenu.PROG_NM + '" data-title="' + lowMenu.MENU_NM + '">' +
                      '<p>' + lowMenu.MENU_NM + '</p>' +
                      '</a>' +
                      '</li>';
            });

            menuHtml += '</ul>' +
                    '</li>';
          });

          menuHtml += '</ul>' +
                  '</li>';
        });
      }

      $('#dynamic-menu').html(menuHtml);
    }

    // 아이콘 클래스 반환 함수 추가
    function getIconClass(menuName) {
      var iconMapping = {
        "관리자": "fas fa-user-shield",
        "기본정보": "fas fa-users",
        "시스템": "fas fa-cog",
        "마일리지": "fas fa-project-diagram",
        "통계": "fas fa-chart-line",
        "프로젝트": "fas fa-tachometer-alt",
        "고객관리": "fas fa-users",
        "상담관리": "fas fa-phone",
        "게시판": "fas fa-clipboard",
      };
      return iconMapping[menuName] || "fas fa-arrow-right";
    }

    // 메뉴 데이터 생성 및 초기화
    try {
      var menuData = JSON.parse(menuDataString || '[]');
      initializeMenu(menuData);
    } catch (e) {
      console.error('Failed to parse menu data:', e);
    }
  });
</script>

<script src="/js/tab-manager.js"></script>

<script>
  window.addEventListener('load', function() {
    console.log('페이지 로드 완료');
    if (window.TabManager && typeof TabManager.initTabManager === 'function') {
      TabManager.initTabManager();
    } else {
      console.error('TabManager가 제대로 로드되지 않았거나 initTabManager 함수를 찾을 수 없습니다.');
    }
  });
</script>
</body>
</html>
