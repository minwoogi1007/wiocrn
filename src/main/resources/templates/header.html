
<div th:fragment="header">
  <meta charset="UTF-8">
  <style>
    body, table, th, td, input {
      font-size: 9pt;
    }
    table th {
      background-color: #efefef;
    }/* 숨김 스타일 추가 */
    .hidden {
      position: absolute;
      left: -9999px;
      top: -9999px;
    }
  </style>
  <script th:inline="javascript">
    /*<![CDATA[*/
    var strLoginID = /*[[${userInfo}]]*/ 'null';
    var strLoginPwd = "!alsdnrdl10";
    /*]]>*/
  </script>

  <script id="OnSendRingEvent" for="EventClientCtrl" event="SendRingEvent(bstrRingEvent)">

    parseMsg(bstrRingEvent);
  </script>

  <script id="OnSendLoginResultEvent" for="EventClientCtrl" event="SendLoginResultEvent(bstrLoginResult)">
    parseMsg(bstrLoginResult);
  </script>



  <script id="OnSendChannelListEvent" for="EventClientCtrl" event="SendChannelListEvent(bstrChannelList)">

    if(call_UinqId == ""){
      parseMsg(bstrChannelList,"HAND");
    }else{
      parseMsg(bstrChannelList);
    }
    //전화연결시
    document.getElementById("stateMsg").innerHTML="통화중";

  </script>
  <script id="OnSendChannelOutEvent" for="EventClientCtrl" event="SendChannelOutEvent(bstrChannelOut)">
    giCallStatus ='0';
    parseMsg(bstrChannelOut);
  </script>


  <script id="OnSendNetworkErrorEvent" for="EventClientCtrl" event="SendNetworkErrorEvent()">
    document.all.EventClientCtrl.DisconnectServer();
    //alert("네트웍 오류로 인한 ocx 서버에 연결할 수 없습니다. \n 관리자에게 문의 하세요");
    reJoin();
  </script>



  <nav class="main-header navbar navbar-expand navbar-white navbar-light">
    <ul class="navbar-nav">
      <li class="nav-item">
        <a class="nav-link" data-widget="pushmenu" href="#" role="button"><i class="fas fa-bars"></i></a>
      </li>
      <li class="nav-item d-none d-sm-inline-block">
        <a href="#" class="nav-link">WIO</a><span class="call_font"> 내선:<span th:text="${userInfo}"></span><span id="connectionStatus"></span></span>
      </li>
    </ul>
    <form name="iform" id="iform" style="margin:0;padding:0;">
      <!-- Other form contents -->
      <input type="button" onClick="document.getElementById('recvlog').value='';" value="ClearLog"><br>
      <textarea style="width:100%;height:350px;" name="recvlog" id="recvlog"></textarea>
      <div name="dispinfo" id="dispinfo" style="width:100%;"></div>
    </form>
    <div class="row mt-3">
      <div class="col-12">
        <div class="d-flex justify-content-between">
          <button id='send_b1' class="btn btn-danger" style="display:none;" onClick="hangup()">끊기</button>
          <button id='send_b2' class="btn btn-warning" style="display:none;" onClick="hold()">보류</button>
          <button id='send_b3' class="btn btn-success" style="display:none;" onClick="unhold()">재연결</button>
          <button id='init_b1' class="btn btn-primary" style="display:none;" onClick="call()">전화걸기</button>
          <button id='init_b2' class="btn btn-secondary" style="display:none;" onClick="pickup()">당겨받기</button>
          <button id='init_b3' class="btn btn-info" style="display:none;" onClick="p_answer()">전화받기</button>
          <button id='init_b4' class="btn btn-dark" style="display:none;" onClick="hangup()">수신거부</button>
          <button id='init_b5' class="btn btn-light" style="display:none;" onClick="doConsReg()">상담등록</button>
          <button id='init_b7' class="btn btn-warning" style="display:none;" onClick="outCall()">outCall</button>
          <span id='_timer' class='call_font'></span>
        </div>
      </div>
    </div>
  </nav>
  <div class="hidden">
    <script>
      var OutStr = "<object ID='EventClientCtrl' WIDTH=100 HEIGHT=100 CLASSID='CLSID:86019F2F-2899-4C4C-A6FE-24CFF7CD6D4C' codebase='/activeXLGUBaseOpenApi_1.0.1.21.cab#version=1,0,1,21'></object>";
      document.writeln(OutStr);
    </script>
  </div>
  <script>



    var ISCON = 0;
    var ISCALL = 0;
    var STAT = 0;
    var READY = 0;
    var timerID = null;
    var isExtened = 0;
    var PhoneNum = "";
    var PhoneCaller = "";
    var popuptime = 0;

    function initializeAndConnect() {
      READY = 1;
      console.log("initializeAndConnect 호출됨");
      document.getElementById('connectionStatus').innerText = "접속 시도 중...";
      sConnect();
    }

    function sConnect(ctype) {
      console.log("sConnect 호출됨");
      if (!READY) {
        alert("컨트롤이 시작되지 못했습니다.");
        document.getElementById('connectionStatus').innerText = "접속 안됨";
        return false;
      }
      if (ISCON) {
        console.log("기존 연결 해제 시도");
        document.getElementById('EventClientCtrl').DisconnectServer();
        ISCON = 0;
      } else {
        console.log("서버에 로그인 시도");
        console.log(strLoginID);
        console.log(strLoginPwd);
        var strServerIP = "203.233.92.82";
        document.getElementById('EventClientCtrl').LoginServer(strLoginID, strLoginPwd, strServerIP);

      }
      CheckConnect();
      return false;
    }

    function CheckConnect() {
      if (document.getElementById('EventClientCtrl') != null) {
        var bConnect = document.getElementById('EventClientCtrl').IsConnected();
        console.log("CheckConnect 호출됨: " + bConnect);

        if (bConnect) document.getElementById("connectionStatus").innerHTML = "대기중";
        else document.getElementById("connectionStatus").innerHTML = "연결실패";
      }
    }

    function BBS_LOGIN() {
      call_btn_cont('R');
    }

    function call_btn_cont(_Arg) {
      switch (_Arg) {
        case "CS":
          document.getElementById("send_b1").style.display = "inline";
          document.getElementById("send_b2").style.display = "inline";
          document.getElementById("send_b3").style.display = "inline";
          document.getElementById("init_b3").style.display = "none";
          document.getElementById("init_b4").style.display = "none";
          document.getElementById("init_b5").style.display = "none";
          document.getElementById("init_b7").style.display = "none";
          break;
        case "R":
          document.getElementById("init_b3").style.display = "inline";
          document.getElementById("init_b4").style.display = "inline";
          document.getElementById("init_b5").style.display = "inline";
          document.getElementById("init_b7").style.display = "inline";
          break;
      }
    }

    function parseMsg(msg) {
      console.log("parseMsg 호출됨: " + msg);
      var recvlogElement = document.getElementById('recvlog');
      recvlogElement.value += msg + "\n";

      var msgs = msg.split("|");
      var Insp = new Object();
      Insp["EVENT"] = msgs[0];
      var disp = "";
      for (var i = 1; i < msgs.length; i++) {
        var keyval = msgs[i].split(":");
        Insp[keyval[0]] = keyval[1];
      }

      var caller = Insp["CALLERID"];
      var caller1 = Insp["CALLER1ID"];
      var caller2 = Insp["CALLER2ID"];
      var channel1 = Insp["CHANNEL1"];
      var channel2 = Insp["CHANNEL2"];
      var msg = Insp["MSG"];
      var status = Insp["STATUS"];

      if (Insp["EVENT"] == "CMDRESULT") {
        // Handle CMDRESULT event
      } else if (Insp["EVENT"] == "RINGEVENT") {
        alert("전화가 왔습니다: " + Insp["CALLERID"]);
        setInfoval(Insp["CHANNEL"], Insp["RECHANNEL"], Insp["ISDIAL"], Insp["EVENT"], Insp, 1);
      } else if (Insp["EVENT"] == "LOGINRESULT") {
        if (status == "1") {
          console.log("로그인 성공");
          BBS_LOGIN();
          var linfos = msg.split(",");
          var PhoneNum = linfos[0];
          var UserExten = Insp["EXTEN"];
          var PhoneCaller = linfos[1];
          ISCON = 1;
          document.getElementById('loginStatus').innerHTML = "로그인성공:" + PhoneNum + "/" + PhoneCaller;
          document.getElementById('connectionStatus').innerText = "대기중";
        } else {
          console.log("로그인 실패");
          document.getElementById('EventClientCtrl').DisconnectServer();
          document.getElementById('loginStatus').innerHTML = "로그인실패";
          document.getElementById('connectionStatus').innerText = "접속 안됨";
          alert("LOGIN 실패:" + msg);
        }
      } else if (Insp["EVENT"] == "CHANNELLIST") {
        setInfoval(Insp["CHANNEL1"], Insp["CHANNEL2"], ISCALL, Insp["EVENT"], Insp, 2);
      } else if (Insp["EVENT"] == "CHANNELOUT") {
        setInfoval(Insp["CHANNEL"], Insp["RECHANNEL"], "", Insp["EVENT"], Insp, 0);
      }
      return false;
    }

    function hangup() {
      document.getElementById("EventClientCtrl").Hangup();
      document.getElementById("stateMsg").innerHTML = "대기중";
      location.reload();
    }

    function hold() {
      document.getElementById("EventClientCtrl").Hold();
      document.getElementById("stateMsg").innerHTML = "보류";
    }

    function unhold() {
      document.getElementById("EventClientCtrl").Unhold();
      document.getElementById("stateMsg").innerHTML = "재연결";
    }

    window.onload = function() {
      initializeAndConnect();
    }
  </script>

  <script for="EventClientCtrl" event="SendCommandResultEvent(bstrCommandResult)">
    console.log("SendCommandResultEvent 호출됨")
    CommandResultEvent(bstrCommandResult);
  </script>
  <script for="EventClientCtrl" event="SendNetworkErrorEvent()">
    console.log("SendNetworkErrorEvent 호출됨");
    document.getElementById('EventClientCtrl').DisconnectServer();
    document.getElementById('BtnCONN').value = "접속";
    document.getElementById('loginStatus').innerHTML = "접속종료";

    ISCON = 0;
    document.getElementById('recvlog').value += "disconnected......\n";
  </script>


</div>
