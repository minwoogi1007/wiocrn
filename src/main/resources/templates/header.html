
<div th:fragment="header">
  <meta charset="UTF-8">
  <style>
    body, table, th, td, input {
      font-size: 9pt;
    }
    table th {
      background-color: #efefef;
    }
  </style>
  <script th:inline="javascript">
    /*<![CDATA[*/
    var strLoginID = /*[[${userInfo}]]*/ 'null';
    var strLoginPwd = "!alsdnrdl10";
    /*]]>*/
  </script>

  <nav class="main-header navbar navbar-expand navbar-white navbar-light">
    <ul class="navbar-nav">
      <li class="nav-item">
        <a class="nav-link" data-widget="pushmenu" href="#" role="button"><i class="fas fa-bars"></i></a>
      </li>
      <li class="nav-item d-none d-sm-inline-block">
        <a href="#" class="nav-link">WIO</a><span class="call_font"> 내선:<span th:text="${userInfo}"></span><span id="connectionStatus"></span></span>
      </li>
    </ul>
    <form name="iform" id="iform" style="margin:0;padding:0;">
      <!-- Other form contents -->
      <input type="button" onClick="document.getElementById('recvlog').value='';" value="ClearLog"><br>
      <textarea style="width:100%;height:350px;" name="recvlog" id="recvlog"></textarea>
      <div name="dispinfo" id="dispinfo" style="width:100%;"></div>
    </form>
  </nav>
  <!-- Additional body content from dcs_lgapi.html -->

  <script>
    var ISCON = 0;
    var ISCALL = 0;
    var STAT = 0;
    var READY = 0;
    var timerID = null;
    var isExtened = 0;
    var PhoneNum = "";
    var PhoneCaller = "";
    var popuptime = 0;

    function initializeAndConnect() {
      READY = 1;
      console.log("initializeAndConnect 호출됨");
      document.getElementById('connectionStatus').innerText = "접속 시도 중...";
      sConnect();
    }

    function sConnect(ctype) {
      console.log("sConnect 호출됨");
      if (!READY) {
        alert("컨트롤이 시작되지 못했습니다.");
        document.getElementById('connectionStatus').innerText = "접속 안됨";
        return false;
      }
      if (ISCON) {
        console.log("기존 연결 해제 시도");
        document.getElementById('EventClientCtrl').DisconnectServer();
        ISCON = 0;
      } else {
        console.log("서버에 로그인 시도");
        var strServerIP = "203.233.92.82"; // 서버 IP 고정
        document.getElementById('EventClientCtrl').LoginServer(strLoginID, strLoginPwd, strServerIP);
      }
      return false;
    }

    function parseMsg(msg) {
      console.log("parseMsg 호출됨: " + msg);
      var recvlogElement = document.getElementById('recvlog');
      recvlogElement.value += msg + "\n";

      var msgs = msg.split("|");
      var Insp = new Object();
      Insp["EVENT"] = msgs[0];
      var disp = "";
      for (var i = 1; i < msgs.length; i++) {
        var keyval = msgs[i].split(":");
        Insp[keyval[0]] = keyval[1];
      }

      var caller = Insp["CALLERID"];
      var caller1 = Insp["CALLER1ID"];
      var caller2 = Insp["CALLER2ID"];
      var channel1 = Insp["CHANNEL1"];
      var channel2 = Insp["CHANNEL2"];
      var msg = Insp["MSG"];
      var status = Insp["STATUS"];

      if (Insp["EVENT"] == "CMDRESULT") {
        // Handle CMDRESULT event
      } else if (Insp["EVENT"] == "RINGEVENT") {
        setInfoval(Insp["CHANNEL"], Insp["RECHANNEL"], Insp["ISDIAL"], Insp["EVENT"], Insp, 1);
      } else if (Insp["EVENT"] == "LOGINRESULT") {
        if (status == "1") {
          console.log("로그인 성공");
          viewMenu('CtiTable', 1);
          document.getElementById('BtnCONN').value = "종료";
          var linfos = msg.split(",");
          var PhoneNum = linfos[0];
          var UserExten = Insp["EXTEN"];
          var PhoneCaller = linfos[1];
          ISCON = 1;
          document.getElementById('loginStatus').innerHTML = "로그인성공:" + PhoneNum + "/" + PhoneCaller;
          document.getElementById('connectionStatus').innerText = "대기중";
        } else {
          console.log("로그인 실패");
          document.getElementById('EventClientCtrl').DisconnectServer();
          document.getElementById('loginStatus').innerHTML = "로그인실패";
          document.getElementById('connectionStatus').innerText = "접속 안됨";
          alert("LOGIN 실패:" + msg);
        }
      } else if (Insp["EVENT"] == "CHANNELLIST") {
        setInfoval(Insp["CHANNEL1"], Insp["CHANNEL2"], ISCALL, Insp["EVENT"], Insp, 2);
      } else if (Insp["EVENT"] == "CHANNELOUT") {
        setInfoval(Insp["CHANNEL"], Insp["RECHANNEL"], "", Insp["EVENT"], Insp, 0);
      }
      return false;
    }

    window.onload = function() {
      initializeAndConnect();
    }
  </script>

  <script for="EventClientCtrl" event="SendRingEvent(bstrRingEvent)">
    parseMsg(bstrRingEvent);
  </script>
  <script for="EventClientCtrl" event="SendChannelListEvent(bstrChannelList)">
    parseMsg(bstrChannelList);
  </script>
  <script for="EventClientCtrl" event="SendChannelOutEvent(bstrChannelOut)">
    parseMsg(bstrChannelOut);
  </script>
  <script for="EventClientCtrl" event="SendLoginResultEvent(bstrLoginResult)">
    parseMsg(bstrLoginResult);
  </script>
  <script for="EventClientCtrl" event="SendCommandResultEvent(bstrCommandResult)">
    CommandResultEvent(bstrCommandResult);
  </script>
  <script for="EventClientCtrl" event="SendNetworkErrorEvent()">
    document.getElementById('EventClientCtrl').DisconnectServer();
    document.getElementById('BtnCONN').value = "접속";
    document.getElementById('loginStatus').innerHTML = "접속종료";

    viewMenu('CtiTable');
    ISCON = 0;
    document.getElementById('recvlog').value += "disconnected......\n";
  </script>
  <script for="EventClientCtrl" event="SendEtcEvent(strEventName, strEventValue)">
    EtcEvent(strEventName, strEventValue);
  </script>
  <script for="EventClientCtrl" event="SendSMSEvent(strEventValue)">
    EtcEvent("SendSMSEvent", strEventValue);
  </script>
  <script for="EventClientCtrl" event="SendPeerMsgEvent(strEventValue)">
    EtcEvent("SendPeerMsgEvent", strEventValue);
  </script>
  <script for="EventClientCtrl" event="SendCmdErrorEvent(strCmd, strEventValue)">
    if (strCmd != "Connect") {
      alert("CmdError: cmd(" + strCmd + ")" + strEventValue);
    }
    EtcEvent("SendDtmfEvent", strEventValue);
  </script>

  <object style="display:none;" id="EventClientCtrl" classid="CLSID:86019F2F-2899-4C4C-A6FE-24CFF7CD6D4C" codebase="/activeXLGUBaseOpenApi_1.0.1.21.cab#version=1,0,1,21"></object>
</div>
